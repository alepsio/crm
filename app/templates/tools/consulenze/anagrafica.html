{% extends 'base.html' %}

{% block title %}Anagrafica Clienti - Gestione Consulenze Assicurative{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3"><i class="bi bi-person-plus"></i> Anagrafica Clienti</h1>
        <a href="{{ url_for('consulenze_panoramica') }}" class="btn btn-outline-primary">
            <i class="bi bi-table"></i> Visualizza Clienti
        </a>
    </div>
    
    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Inserimento Nuovo Cliente</h5>
            <button type="button" class="btn btn-outline-warning btn-sm" id="generateTestDataBtn">
                <i class="bi bi-magic"></i> Genera Dati Test
            </button>
        </div>
        <div class="card-body">
            <form method="post" action="{{ url_for('consulenze_anagrafica') }}" enctype="multipart/form-data">
                <div class="row">
                    <!-- Dati Anagrafici -->
                    <div class="col-md-12 mb-3">
                        <h5 class="border-bottom pb-2"><i class="bi bi-person"></i> Dati Anagrafici</h5>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="nome" class="form-label">Nome *</label>
                        <input type="text" class="form-control" id="nome" name="nome" required>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="cognome" class="form-label">Cognome *</label>
                        <input type="text" class="form-control" id="cognome" name="cognome" required>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="codice_fiscale" class="form-label">Codice Fiscale *</label>
                        <input type="text" class="form-control" id="codice_fiscale" name="codice_fiscale" required maxlength="16">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="data_nascita" class="form-label">Data di Nascita</label>
                        <input type="date" class="form-control" id="data_nascita" name="data_nascita">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="luogo_nascita" class="form-label">Luogo di Nascita</label>
                        <input type="text" class="form-control" id="luogo_nascita" name="luogo_nascita">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="partita_iva" class="form-label">Partita IVA</label>
                        <input type="text" class="form-control" id="partita_iva" name="partita_iva" maxlength="11">
                    </div>
                    
                    <!-- Contatti -->
                    <div class="col-md-12 mt-2 mb-3">
                        <h5 class="border-bottom pb-2"><i class="bi bi-envelope"></i> Contatti</h5>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="pec" class="form-label">PEC</label>
                        <input type="email" class="form-control" id="pec" name="pec">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="cellulare" class="form-label">Cellulare *</label>
                        <input type="tel" class="form-control" id="cellulare" name="cellulare" required>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="codice_univoco" class="form-label">Codice Univoco</label>
                        <input type="text" class="form-control" id="codice_univoco" name="codice_univoco" maxlength="7">
                    </div>
                    
                    <!-- Attività Professionale -->
                    <div class="col-md-12 mt-2 mb-3">
                        <h5 class="border-bottom pb-2"><i class="bi bi-briefcase"></i> Attività Professionale</h5>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="attivita" class="form-label">Attività</label>
                        <input type="text" class="form-control" id="attivita" name="attivita">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="data_inizio_attivita" class="form-label">Data Inizio Attività</label>
                        <input type="date" class="form-control" id="data_inizio_attivita" name="data_inizio_attivita">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="iscrizione_albo_data" class="form-label">Data Iscrizione Albo</label>
                        <input type="date" class="form-control" id="iscrizione_albo_data" name="iscrizione_albo_data">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="iscrizione_albo_numero" class="form-label">Numero Iscrizione Albo</label>
                        <input type="text" class="form-control" id="iscrizione_albo_numero" name="iscrizione_albo_numero">
                    </div>
                    
                    <!-- Indirizzi -->
                    <div class="col-md-12 mt-2 mb-3">
                        <h5 class="border-bottom pb-2"><i class="bi bi-geo-alt"></i> Indirizzi</h5>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="residenza" class="form-label">Residenza</label>
                        <textarea class="form-control" id="residenza" name="residenza" rows="2"></textarea>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="domicilio_fiscale" class="form-label">Domicilio Fiscale</label>
                        <textarea class="form-control" id="domicilio_fiscale" name="domicilio_fiscale" rows="2"></textarea>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="ubicazione_studio" class="form-label">Ubicazione Studio</label>
                        <textarea class="form-control" id="ubicazione_studio" name="ubicazione_studio" rows="2"></textarea>
                    </div>
                    
                    <!-- Dati Economici -->
                    <div class="col-md-12 mt-2 mb-3">
                        <h5 class="border-bottom pb-2"><i class="bi bi-cash"></i> Dati Economici</h5>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="fatturato_2024" class="form-label">Fatturato 2024 (€)</label>
                        <input type="number" class="form-control" id="fatturato_2024" name="fatturato_2024" step="0.01" min="0">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="stima_2025" class="form-label">Stima 2025 (€)</label>
                        <input type="number" class="form-control" id="stima_2025" name="stima_2025" step="0.01" min="0">
                    </div>
                    
                    <div class="col-md-4 mb-3 d-flex align-items-center">
                        <div class="form-check me-3">
                            <input class="form-check-input" type="checkbox" id="dipendenti" name="dipendenti">
                            <label class="form-check-label" for="dipendenti">Dipendenti</label>
                        </div>
                        <div class="form-check me-3">
                            <input class="form-check-input" type="checkbox" id="addetti" name="addetti">
                            <label class="form-check-label" for="addetti">Addetti</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="subappaltatori" name="subappaltatori">
                            <label class="form-check-label" for="subappaltatori">Subappaltatori</label>
                        </div>
                    </div>
                    
                    <!-- Dati Polizza Assicurativa -->
                    <div class="col-md-12 mt-2 mb-3">
                        <h5 class="border-bottom pb-2"><i class="bi bi-shield-check"></i> Polizza Assicurativa</h5>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="compagnia_assicurativa" class="form-label">Compagnia Assicurativa</label>
                        <input type="text" class="form-control" id="compagnia_assicurativa" name="compagnia_assicurativa" 
                               placeholder="es. Generali, Allianz, AXA...">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="numero_polizza" class="form-label">Numero Polizza</label>
                        <input type="text" class="form-control" id="numero_polizza" name="numero_polizza" 
                               placeholder="Numero identificativo polizza">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="tipo_polizza" class="form-label">Tipo Polizza</label>
                        <select class="form-select" id="tipo_polizza" name="tipo_polizza">
                            <option value="">Seleziona tipo...</option>
                            <option value="RC Professionale">RC Professionale</option>
                            <option value="RC Generale">RC Generale</option>
                            <option value="Tutela Legale">Tutela Legale</option>
                            <option value="Cyber Risk">Cyber Risk</option>
                            <option value="Infortuni">Infortuni</option>
                            <option value="Malattia">Malattia</option>
                            <option value="Vita">Vita</option>
                            <option value="Auto">Auto</option>
                            <option value="Casa">Casa</option>
                            <option value="Altro">Altro</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="data_scadenza_polizza" class="form-label">
                            <i class="bi bi-calendar-event text-warning"></i> Data Scadenza Polizza
                        </label>
                        <input type="date" class="form-control" id="data_scadenza_polizza" name="data_scadenza_polizza">
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> Utilizzata per automazioni di promemoria
                        </div>
                    </div>
                    
                    <!-- Documenti -->
                    <div class="col-md-12 mt-2 mb-3">
                        <h5 class="border-bottom pb-2"><i class="bi bi-file-earmark"></i> Documenti</h5>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="documento_fronte" class="form-label">Documento Fronte</label>
                        <input type="file" class="form-control" id="documento_fronte" name="documento_fronte" accept="image/*,.pdf">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="documento_retro" class="form-label">Documento Retro</label>
                        <input type="file" class="form-control" id="documento_retro" name="documento_retro" accept="image/*,.pdf">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="polizza_precedente" class="form-label">Polizza Precedente</label>
                        <input type="file" class="form-control" id="polizza_precedente" name="polizza_precedente" accept="image/*,.pdf">
                    </div>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                    <button type="reset" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-x-circle"></i> Annulla
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Salva Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Validazione codice fiscale
    document.getElementById('codice_fiscale').addEventListener('input', function() {
        this.value = this.value.toUpperCase();
    });
    
    // Validazione partita IVA
    document.getElementById('partita_iva').addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
    });
    
    // Funzione per generare dati di test
    document.getElementById('generateTestDataBtn').addEventListener('click', function() {
        // Array di nomi e cognomi italiani
        const nomi = ['Mario', 'Luigi', 'Giuseppe', 'Francesco', 'Antonio', 'Marco', 'Andrea', 'Alessandro', 'Matteo', 'Lorenzo', 'Davide', 'Simone', 'Luca', 'Stefano', 'Federico', 'Giulia', 'Francesca', 'Chiara', 'Sara', 'Martina', 'Giorgia', 'Silvia', 'Valentina', 'Alessia', 'Jessica', 'Elisa', 'Federica', 'Ilaria', 'Cristina', 'Paola'];
        const cognomi = ['Rossi', 'Russo', 'Ferrari', 'Esposito', 'Bianchi', 'Romano', 'Colombo', 'Ricci', 'Marino', 'Greco', 'Bruno', 'Gallo', 'Conti', 'De Luca', 'Mancini', 'Costa', 'Giordano', 'Rizzo', 'Lombardi', 'Moretti', 'Barbieri', 'Fontana', 'Santoro', 'Mariani', 'Rinaldi', 'Caruso', 'Ferrara', 'Galli', 'Martini', 'Leone'];
        
        // Genera nome e cognome casuali
        const nome = nomi[Math.floor(Math.random() * nomi.length)];
        const cognome = cognomi[Math.floor(Math.random() * cognomi.length)];
        
        // Genera codice fiscale fittizio (16 caratteri alfanumerici)
        function generateCodiceFiscale() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 16; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Genera email basata su nome e cognome
        const email = `${nome.toLowerCase()}.${cognome.toLowerCase()}@test.com`;
        
        // Genera numero di cellulare italiano
        const cellulare = `3${Math.floor(Math.random() * 9) + 1}${Math.floor(Math.random() * 90000000) + 10000000}`;
        
        // Conferma prima di compilare
        Swal.fire({
            title: 'Genera Dati Test',
            text: 'Vuoi compilare automaticamente i campi obbligatori con dati casuali per il test?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#ffc107',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sì, genera!',
            cancelButtonText: 'Annulla'
        }).then((result) => {
            if (result.isConfirmed) {
                // Compila i campi obbligatori
                document.getElementById('nome').value = nome;
                document.getElementById('cognome').value = cognome;
                document.getElementById('codice_fiscale').value = generateCodiceFiscale();
                document.getElementById('email').value = email;
                document.getElementById('cellulare').value = cellulare;
                
                // Mostra toast di conferma
                Swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title: 'Dati generati!',
                    text: `Cliente test: ${nome} ${cognome}`,
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                    toast: true
                });
                
                // Evidenzia i campi compilati con un effetto
                const campiCompilati = ['nome', 'cognome', 'codice_fiscale', 'email', 'cellulare'];
                campiCompilati.forEach(campo => {
                    const element = document.getElementById(campo);
                    element.style.backgroundColor = '#fff3cd';
                    element.style.borderColor = '#ffc107';
                    
                    // Rimuovi l'evidenziazione dopo 3 secondi
                    setTimeout(() => {
                        element.style.backgroundColor = '';
                        element.style.borderColor = '';
                    }, 3000);
                });
            }
        });
    });
</script>
{% endblock %}